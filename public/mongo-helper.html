<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MongoDB Connection Helper</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }
    h1, h2, h3 {
      color: #2E5EAA;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .steps {
      background-color: #f5f7fa;
    }
    button {
      background-color: #2E5EAA;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background-color: #1E478A;
    }
    .result {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
      background-color: #f9f9f9;
      white-space: pre-wrap;
      max-height: 300px;
      overflow: auto;
      font-family: monospace;
    }
    .error {
      color: #d32f2f;
      font-weight: bold;
    }
    .success {
      color: #388e3c;
      font-weight: bold;
    }
    .code {
      background-color: #f0f0f0;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      overflow-x: auto;
    }
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>MongoDB Connection Helper</h1>
  
  <div class="card">
    <h2>Test Your MongoDB Connection</h2>
    <p>Click the buttons below to run tests and diagnose your MongoDB connection issues.</p>
    
    <div class="test-grid">
      <button onclick="testDbConnection()">Test Database Connection</button>
      <button onclick="testConnectionSettings()">Test Connection Settings</button>
      <button onclick="testIsMongoRunning()">Check If MongoDB Is Running</button>
      <button onclick="testContact()">Test Contact Form</button>
    </div>
    
    <div class="result" id="result">Results will appear here</div>
  </div>
  
  <div class="card steps">
    <h2>Troubleshooting Steps</h2>
    
    <h3>1. Check if MongoDB is running locally</h3>
    <p>If you're using a local MongoDB installation:</p>
    <ul>
      <li>Make sure MongoDB service is running: <code>mongod</code></li>
      <li>On Windows: Check Services app for "MongoDB Server"</li>
      <li>On Mac/Linux: Run <code>ps aux | grep mongod</code> to see if it's running</li>
    </ul>
    
    <h3>2. Verify your connection string in .env file</h3>
    <p>Your connection string should match one of these formats:</p>
    <div class="code">
      # Local MongoDB<br>
      MONGODB_URI=mongodb://localhost:27017/schooldb<br><br>
      # MongoDB Atlas<br>
      MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/schooldb<br><br>
      # Custom MongoDB server<br>
      MONGODB_URI=mongodb://username:password@hostname:port/schooldb
    </div>
    
    <h3>3. Check MongoDB Compass</h3>
    <p>If you're using MongoDB Compass:</p>
    <ol>
      <li>Open MongoDB Compass</li>
      <li>Connect to your database</li>
      <li>In the connection dialog, there's a "Copy" button for the connection string</li>
      <li>Paste this string into your .env file as MONGODB_URI</li>
      <li>Make sure to include the database name at the end (e.g., /schooldb)</li>
    </ol>
    
    <h3>4. Vercel Environment Variables</h3>
    <p>If deploying to Vercel:</p>
    <ol>
      <li>Go to your Vercel dashboard</li>
      <li>Select your project</li>
      <li>Go to Settings > Environment Variables</li>
      <li>Add MONGODB_URI with your connection string</li>
      <li>Redeploy your application</li>
    </ol>
  </div>
  
  <script>
    // Helper function to display results
    function showResult(content, isSuccess = true) {
      const resultEl = document.getElementById('result');
      if (isSuccess) {
        resultEl.innerHTML = `<div class="success">✅ Success</div><pre>${JSON.stringify(content, null, 2)}</pre>`;
      } else {
        resultEl.innerHTML = `<div class="error">❌ Error</div><pre>${JSON.stringify(content, null, 2)}</pre>`;
      }
    }
    
    // Test MongoDB connection
    async function testDbConnection() {
      const resultEl = document.getElementById('result');
      resultEl.textContent = 'Testing database connection...';
      
      try {
        const response = await fetch('/api/test-db');
        const result = await response.json();
        
        if (result.success) {
          showResult(result, true);
        } else {
          showResult(result, false);
        }
      } catch (error) {
        showResult({
          message: 'Error testing connection',
          error: error.message
        }, false);
      }
    }
    
    // Test connection settings
    async function testConnectionSettings() {
      const resultEl = document.getElementById('result');
      resultEl.textContent = 'Checking MongoDB connection settings...';
      
      try {
        const response = await fetch('/api/test-db');
        const result = await response.json();
        
        // Extract just the relevant environment info
        const envInfo = result.environment || {};
        
        showResult({
          message: 'MongoDB connection settings',
          hasMongoUri: envInfo.hasMongoUri,
          uriSet: envInfo.mongoUriStart !== 'not set',
          mongoUriStart: envInfo.mongoUriStart,
          nodeEnvironment: envInfo.nodeEnv,
          usingLocalhost: envInfo.mongoUriStart && envInfo.mongoUriStart.includes('localhost')
        }, true);
      } catch (error) {
        showResult({
          message: 'Error checking connection settings',
          error: error.message
        }, false);
      }
    }
    
    // Test if MongoDB is running locally
    async function testIsMongoRunning() {
      const resultEl = document.getElementById('result');
      resultEl.textContent = 'Checking if MongoDB is running locally...';
      
      try {
        // Try to fetch directly from MongoDB status endpoint
        const checkLocalMongo = () => {
          return new Promise((resolve) => {
            const img = new Image();
            // Set a timeout in case MongoDB isn't running
            const timeout = setTimeout(() => {
              resolve(false);
            }, 1000);
            
            img.onload = () => {
              clearTimeout(timeout);
              resolve(true);
            };
            
            img.onerror = () => {
              clearTimeout(timeout);
              // This error is expected if not running - not a problem
              resolve(false);
            };
            
            // Try to load the MongoDB status page favicon
            img.src = 'http://localhost:27017/favicon.ico?_=' + Date.now();
          });
        };
        
        const isRunning = await checkLocalMongo();
        
        showResult({
          message: isRunning ? 'MongoDB appears to be running locally' : 'MongoDB does not appear to be running locally',
          isRunning: isRunning,
          recommendedAction: isRunning ? 
            'Your local MongoDB is running. Check if you have the correct database name in your connection string.' : 
            'Start MongoDB with the mongod command or start the MongoDB service in your system.'
        }, true);
      } catch (error) {
        showResult({
          message: 'Error checking if MongoDB is running',
          error: error.message
        }, false);
      }
    }
    
    // Test contact form submission
    async function testContact() {
      const resultEl = document.getElementById('result');
      resultEl.textContent = 'Testing contact form submission...';
      
      try {
        const testData = {
          name: 'Test User',
          email: 'test@example.com',
          phone: '1234567890',
          subject: 'Database Test',
          message: 'This is a test message sent from the MongoDB helper.'
        };
        
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(testData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showResult(result, true);
        } else {
          showResult(result, false);
        }
      } catch (error) {
        showResult({
          message: 'Error submitting form',
          error: error.message
        }, false);
      }
    }
  </script>
</body>
</html> 